---
title: "Airbnb - Chicago property analysis and exploration"
author: "Data wrangling in R project by Samrudh Keshava Kumar"
date: '`r Sys.Date()`'
runtime: shiny
output: 
  rmarkdown::html_document:
    theme: sandstone
    code_folding: "show"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# {.tabset}

##Introduction 
###Problem Statement: 
Understand the demand for short term rentals in Chicago and the value being generated by location, type of property and the ratings/reviews of the host. 
This project would benefit anyone making a real-estate investment with the purpose of generating rental earnings in Chicago. This analysis would also be useful for travellers visiting chicago and would like to know the best possible dwelling to book based on price, location, rating of the host and other constrains. 

###Data
The type of data required for this analysis would be information on the hosts, the type, location and price of the dwelling they are renting out etc. The Airbnb dataset available [here](http://insideairbnb.com/get-the-data.html) has all these parameters and much more.

###Approach/Implementation
The approach would be to visualize using plots and maps the trends such as:

* Location vs price
* Review rating vs price 
* Property demand vs location 
* Property profit vs location
* RShiny Dashboard


###Usage
An real-estate investor looking gain rental income could identify areas around Chicago having a demand and supply mismatch and chose to invest in a property he sees fit. A traveler who looking for a stay in Chicago can filter by location/neighborhood, price, type of property and verified hosts with a high rating, thus reducing the decision time. 

###

## Required Packages
###The following packages were used: 
* `Tibble`: Used to store data as a tibble, and makes it much easier to handle and manipulate data
* `Tidyverse`: Used for data manipulation
* `Readr`: Used for importing csv files quickly
* `tidyr`: To tidy messy data 
* `dplyr`: For data manipulation
* `magrittr`: Is contained within dplyr gives the pipe functionality
* `knitr`: Used to display scrollable tables in a neat format
* `leaflet`: Used to plot the Airbnb listings on a map
* `shiny`: To create reactive dashboards within the document 
* `geosphere`: To calculate the distance between two coordinates 
```{r, echo = F}
list_packages <- c("tibble", "tidyverse", "readr", "knitr", "leaflet", "shiny", "geosphere")
new_packages <- list_packages[!(list_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
```
```{r, message= F, warning=F}
library(tibble)
library(tidyverse)
library(readr)
library(knitr)
library(leaflet)
library(shiny)
library(geosphere)

```
###

## Data Preparation 
This section contains all the codes to get the dataset ready for analysis. 

###{.tabset}

#### Data Import 

##### Inside Airbnb dataset
The dataset is obtained from an independent and non-commercial entity called [Inside Airbnb](http://insideairbnb.com/about.html). The provider scrapes the Airbnb website and gathers publicly available data. The original purpose of this dataset is to figure out if hosts are renting out residential properties permanently as opposed to sharing residents with tourists. 

The dataset contains 5207 observations and 95 variables. The dataset contains listings of hosts in Chicago, 5207 listings are unique

Data import code: 
```{r, warning = F, messages = F}
library(readr)
##Import data 
html <- "https://raw.githubusercontent.com/samrudhkumar/R_project/master/listings.csv"
suppressMessages(listings_df <- read_csv(html,na = c("", " ", "N/A")))
class(listings_df)
colnames(listings_df)
```

#####

#### Data Cleaning

The first part of data cleaning involves removing unwanted variables from the table. The original dataset contains 95 variables, 29 variables were extracted for further analysis. 

Then we check the data for missing values across variables, 6 columns had one or more missing value(s). 

Cleaning code: 

* Step 1: 
Collect only variables that will be useful for the analysis and discard the rest
```{r, warning = F, messages = F}
##Extract only the seemingly useful variables and discard the rest
library(stringr)
reduced_listings <- listings_df[, c(1,23,26,27, 29, 40, 44, 49,50, 52:58, 61, 65:68, 72:75, 77, 80, 90,91)] 
  dim(reduced_listings) 
  colnames(reduced_listings)
  ## data has 5207 obs and 29 variables few columns are of wrong data type 
```
* Step 2: 
Calculate the no of missing values in each column using the colSums function
```{r, warning = F, messages = F}
##Calculate no of missing values for each variable
  colSums(is.na(reduced_listings))
  ###62 zipcodes, 1290 cleaning_fee, 738 reviews_scores, 710 reviews_per month, 
  ##1 bedrooms, 3 beds missing ##host_reponse_time 256
  print(paste(sum(colSums(is.na(reduced_listings)) > 0), "Variables have missing values"))
  
```
* Step 3: 
Deal with missing data and data formating issues

The `cleaning_fee` variable has 1290 missing values, the `NA` values mean that the host is not charging a cleaning fee so the values are replaced by 0.

The `host_response_rate` is converted from character type to numeric after removing the `%` symbol from the observations using `str_replace()` from the `stringr` package.

Next we clean the `price`, `cleaning_fee` and `extra_people` variables by removing the `$` symbol and converting it to numeric data type. 

The variables `host_is_superhost` and `instant_bookable` are converted to logical datatype from character using simple ifelse. The cancellation policy is converted to an ordered factor with levels `flexible < moderate < super_strict_60 < super_strict_30 < strict`.

The zipcode is redundant since location information could be obtained from the latitude and longitude variables plus the latter has no missing values thus the zipcode column is dropped from the table.


```{r, warning = F, messages = F}
##Data cleaning
  ##Dealing with missing values
   #missing cleaning fee could be imputed with 0 
    reduced_listings$cleaning_fee[is.na(reduced_listings$cleaning_fee)] <- 0
    reduced_listings$host_response_rate <- as.numeric(str_replace(reduced_listings$host_response_rate,
                                                       "%", ""))

    ##Remove $$ for price, cleaning_fee, extra_people
    reduced_listings$price <- as.numeric(str_replace(reduced_listings$price,
                                                    "\\$", ""))
      
    reduced_listings$cleaning_fee <- as.numeric(str_replace(reduced_listings$cleaning_fee,
                                          "\\$", ""))
    reduced_listings$extra_people <- as.numeric(str_replace(reduced_listings$extra_people,
                                                 "\\$", ""))
    ##Superhost variable to logical 
    reduced_listings$host_is_superhost <- 
      ifelse(reduced_listings$host_is_superhost == 't', T, F)
    ##Convert instant_bookable to logical
    reduced_listings$instant_bookable <- ifelse(reduced_listings$instant_bookable == 't', T, F)
    ##Convert cancellation_policy to factor with levels 
    reduced_listings$cancellation_policy <- factor(reduced_listings$cancellation_policy, levels = c("flexible", "moderate", "super_strict_60", "super_strict_30","strict"), 
                                                               ordered = T)
    
    
    ##Zipcode has 62 missing values this could be completely removed as this is
    #redundant variable, for further analysis latitude and longitude can be used
    clean_listings <- reduced_listings[,!names(reduced_listings) %in% ("zipcode")]
```


#### View clean dataset

```{r, warning = F, message = F}
glimpse(clean_listings)
library(knitr)
kable(head(clean_listings,10))
```

#####

#### Variable Dictionary 

* Table below contains the variable names, data types, description, average and 75th percentile values for numerical data types. 

```{r, warning = F, message = F,results = 'asis', options(knitr.kable.NA = '')}
##Display variable name data type and description 
    variable_name <- colnames(clean_listings)
    variable_descp <- c("Host ID", "Year of listing on Airbnb", 
                        "Time taken by host to respond to bookings", 
                        "No of queries responded",
                        "Host having good ratings (decided by Airbnb)", 
                        "Name of neighborhood",
                        "Latitudinal value of property", "Longitudinal value of property",
                        "Type of property", "Type of room being offered", "Number of guests",
                        "Number of bathrooms", "Number of bedrooms", "Number of beds", 
                        "Type of bed",
                        "Price per night ($)", "Cleaning charges ($)", 
                        "Max number of guests", "Cost for per extra guest ($)",
                        "Minimun number of nights per booking", 
                        "Number of days property was available in span of 30 days",
                        "Number of days property was available in a span of 60 days", 
                        "Number of days property was available in span of 90 days",
                        "Number of days property was available in a span of 365 days",
                        "Number of reviews given",
                        "Rating given out of 100", 
                        "Property can be booked without confirming with host", 
                        "How accomodating is the host for cancellations"
                        )
    col_types <- lapply(clean_listings, class)
    col_75pcent <- lapply(clean_listings, FUN = function(x) ifelse(class(x) == 'numeric' | class(x) == 'integer', quantile(x, 0.75, na.rm = T), NA))
    col_average <- lapply(clean_listings, FUN = function(x) round(mean(x, na.rm = T),2))
    variable_summary <- as.data.frame(cbind(variable_name, col_types, variable_descp,col_average, col_75pcent), row.names = F)
colnames(variable_summary) <- c("Variable Name", "Data Type", 
                                "Description", "Mean", "75th Percentile")
    kable(variable_summary)
```
####


##Data Analysis

###{.tabset}

####Exploratory Data Analysis

#####Understanding performance of Airbnb properties by neighbourhood. 
In this section Airbnb properties are assessed by neighbourhood, here variables such as 
average ratings, price, no of superhosts and distances were explored. Before further analysis is carried out, any columns with `NA` values were omitted and new varaibles were created. The new variables are `total_price` which is cost inclusive of cleaning fee, `price_per_guest` which is the ratio of `total_price` to guests included in the base fee and `dist_from_downtown` which is the great-circle distance between two points on a sphere, calculated using the haversine formula.

```{r, message=F, warning=F}
####Remove any row with missing data 
clean_airbnb <- na.omit(clean_listings)
###create a new column cost per guest, total fee = cleaning + per guest

clean_airbnb %>% 
  mutate(total_price = cleaning_fee + price, price_per_guest = round(total_price / guests_included)) -> clean_airbnb

    ####Profit per month
  clean_airbnb %>% 
    mutate(profit_monthly = (30 - availability_30)*price) -> clean_airbnb
  ##Create a new column for distance to business district
lon_c <- -87.622 ; lat_c <- 41.8794 ##Define lat long of business district
  ##Cal dist in Kilometers 
  
  clean_airbnb$dist_from_downtown <- round(distm(clean_airbnb[,c('longitude','latitude')], 
                                          c(lon_c, lat_c), fun = distHaversine)/1000, 2)
  
```


* Do neighbourhoods closer to the downtown area command higher prices compared to neighbourhoods located further away? To answer this question, the data is filtered and arranged such that neighbourhoods closer to downtown and have a low average price are at the top. The plot of the top 10 neighbourhoods is given below, the bars are sorted in decreasing order of distance from downtown.

```{r, warning= F, message= F, Echo = F}

addline_format <- function(x,...){
  gsub('\\s','\n',x) }
  
clean_airbnb %>%
  select(neighbourhood_cleansed, dist_from_downtown, total_price) %>% 
  group_by(neighbourhood_cleansed) %>% 
  summarise(avg_dist_to_downtown = mean(dist_from_downtown), avg_Price = mean(total_price)) %>%
  arrange(as.numeric(avg_dist_to_downtown), (avg_Price)) %>% 
  head(10) %>% 
  ggplot(aes(x = reorder(neighbourhood_cleansed, avg_dist_to_downtown), y = avg_Price, fill = avg_dist_to_downtown)) + 
  geom_bar(colour="black", stat="identity")+
  labs(x = "Neighbourhood", y = "Average Price of property ($)") + 
  scale_x_discrete( labels = addline_format(unique(clean_airbnb$neighbourhood_cleansed)))+
   scale_fill_continuous(name="Average\nDistance(KM)")

```
There is no trend observed between distance to downtown and the price. The neighbourhoods of Woodlawn and Rogers Park have a low average price and are closer to the downtown area. Travelers who are price sensitive and are looking for places close to downtown Chicago should look at these two neighbourhoods.

* Which neighbourhoods on an average earn higher profits per month? To answer this question, the data is filtered and arranged such that neighbourhoods with high average profit and low average price are at the top. The plot of the top 10 neighbourhoods is given below, the bars are sorted in decreasing order of average price.


```{r, warning= F, message= F, Echo = F}

###Neighbourhood vs profit
clean_airbnb %>%
  select(neighbourhood_cleansed, profit_monthly, total_price) %>% 
  group_by(neighbourhood_cleansed) %>% 
  summarise(avg_profit = mean(profit_monthly), avg_Price = mean(total_price)) %>%
  arrange(desc(as.numeric(avg_profit)), (avg_Price)) %>% 
  head(10) %>% 
  ggplot(aes(x = reorder(neighbourhood_cleansed, -avg_profit), y = avg_profit, fill = avg_Price)) + 
  geom_bar(stat="identity")+
  labs(x = "Neighbourhood", y = "Monthly Profit ($)") + 
  scale_x_discrete( labels = addline_format(unique(clean_airbnb$neighbourhood_cleansed)))+
   scale_fill_continuous(name="Average\nPrice($)")
```

The neighbourhoods of Lincoln Square, Hyde Park and Woodlawn have average monthly profit exceeding $3000. 
The properties in Woodlawn cost on an average \$150 per night while the properties in Lincoln and Hyde Park cost upward of \$225. Woodlawn has a higher occupancy rate (26 days per month) thus the higher profits. Investors could look at investing in properties located in Woodlawn and could expect higher profits and occupancy rates. 

####Exploratory Data Analysis (By property attributes)
In this section we analyse the Airbnb property based on the occupancy, avg cost and if they are instant bookable or not.

* First let us look at instant bookable properties. Given below is average occupancy per month and the average cost of instant bookable properties and non-instant 
bookable ones. 


```{r,message=F, warning=F}
      ## Do instant bookable properties have higher cost? 
  clean_airbnb %>% 
    mutate(occupancy_monthly = (30 - availability_30), instant_ornot = ifelse((instant_bookable), "Instant Bookable", "Confirmation Req.")) %>%
    select(instant_ornot,  occupancy_monthly, total_price) %>%
    group_by(instant_ornot) %>% 
    summarise(avg_occupancy = mean(occupancy_monthly), avg_Cost = mean(total_price),
              count_no = n()) %>% 
    arrange(desc(avg_occupancy)) %>% 
  ggplot(aes(x = instant_ornot, y = avg_Cost, fill = avg_occupancy)) + 
    geom_bar(stat="identity") + labs(x= "Booking type", y = "Average Price ($)") +
   scale_fill_continuous(name="Monthly\nOccupancy")
```

On an average, the monthly occupancy is higher by a day, and the average cost lower
by approx $27. Instant bookable properties do not require the host's confirmation 
and it seems to be the prefered choice for cutomers.

```{r, message=F, warning=F, echo = F}
  ##Instant bookable vs cost, occupancy, profit
  clean_airbnb %>% 
    mutate(occupancy_monthly = (30 - availability_30)) %>%
    select(cancellation_policy,  occupancy_monthly, total_price, profit_monthly) %>%
    group_by(cancellation_policy) %>% 
    summarise(avg_occupancy = mean(occupancy_monthly), avg_Cost = mean(total_price),
              avg_profit = mean(profit_monthly)) %>% 
    arrange(desc(avg_occupancy)) %>% 
    gather(var, value, -cancellation_policy) %>%
    ggplot(aes(x = cancellation_policy, y = value, fill = cancellation_policy, xlab("Cancellation Policy"))) + 
    geom_bar(stat="identity") +
    facet_grid(var~., scales = "free") + labs(x= "Cancellation Policy") +
   scale_fill_discrete(name="Cancellation\nPolicy")
```

Properties with the 'Super Strict 30 cancellation policy' earn the highest profits (~$6500) 
and they generally have a higher average cost, these properties require the guests 
to notify about their cancellation 30 days prior to check-in. 
Properties with 'Super Strict 60' have max occupancy and earn on an average $5000, 
even though the average cost is about $200.

* Let us explore the most popular type of room rented in Chicago. The type of rooms on
offer are Entire House (owners don't live with the guests), Private room (guests get a private room in the same house as the hosts), Shared room (the room will be shared with other people possibly other Airbnb guests). 

```{r,message=F, warning=F, echo = F}
  ##which room_type is popular in chicago?
  clean_airbnb %>% 
    mutate(occupancy_monthly = (30 - availability_30)) %>%
    select(room_type,  occupancy_monthly, profit_monthly) %>%
    group_by(room_type) %>% 
    summarise(avg_occupancy = mean(occupancy_monthly), avg_profit = mean(profit_monthly)) %>% 
    arrange(desc(avg_occupancy)) %>% 
    gather(var, values, -room_type)%>% 
    ggplot(aes(x = room_type, y = values, fill = room_type)) + 
    geom_bar(stat="identity") + facet_grid(var~., scales = "free") + labs(x = "Room Type", y = "Occupancy (per month)") +
   scale_fill_discrete(name="Room\nType")
```

Airbnb guests to Chicago, book entire homes/apartments for their stay. Investors/new hosts, who are willing to offer Entire homes to guests are likely to earn higher monthly profit. 

* Plot property type vs profitability and occupancy

```{r, warning=F, message=F}

##which property_type is popular and is profitable in chicago?
addline_format <- function(x,...){
    gsub('\\s','\n',x)
}
  clean_airbnb %>% 
    mutate(occupancy_monthly = (30 - availability_30)) %>%
    select(property_type,  occupancy_monthly, profit_monthly) %>%
    group_by(property_type) %>% 
    summarise(avg_occupancy = mean(occupancy_monthly), avg_profit = mean(profit_monthly)) %>%
    arrange(desc(avg_profit)) %>% 
    head(10) %>%
    gather(var, values, -property_type)%>% 
    ggplot(aes(x = reorder(property_type, -values), y = values, fill = property_type)) + 
    geom_bar(stat="identity") + facet_grid(var~., scales = "free") + labs(x = "Property Type", y = "Value ($/ Days per month)") + scale_x_discrete( labels = addline_format(unique(clean_airbnb$property_type))) +
   scale_fill_discrete(name="Property\nType")

```

The graph above displays the top 10 property type based on profits per month. The top earner is the property type 'House'. Property of type Townhouse and Condominium have on an average higher occupancy but lower profits. An investor should look at such property while investing.

###

## Dashboard
###Shiny Dashboard
This section contains a shiny dashboard for users to explore the listings in Chicago. It gives the user the flexibility to slice and dice the data based on their requirements. 
The shiny dashboard allows users to filter based on price, rating, room type and neighbourhood which is similar to the filtering on the Airbnb webpage. It also has additional features such as filtering by profit made per month for investors to analyze, option to show only Superhosts, filter by distance from downtown area and property type. The properties have been colored by the total price per night and size by rating. 
Note: The user has to move anyone slider before the points get populated


```{r, echo = FALSE}

library(shiny)
library(RColorBrewer)
library(leaflet)
ui <- bootstrapPage(
      tags$style(type = "text/css", "html, body {width:100%;height:100%}",HTML("
        .selectize-input, .selectize-dropdown {font-size: 75%;}")
                 ),
      leafletOutput("mymap", width = "100%", height = "100%"),
      absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
                    draggable = TRUE, top = 10, left = "auto", right = 20, bottom = "auto",
                    width = 310, height = "auto", style = "opacity: 0.75",
                    div(style="height: 75px; font-size = 75%", sliderInput("price", "Price", min(clean_airbnb$total_price), max(clean_airbnb$total_price),
                                value = range(clean_airbnb$total_price), step = 10
                    )),
                    div(style="height: 75px; font-size = 10px",sliderInput("rating", "Rating", 60, max(clean_airbnb$review_scores_rating),
                                value = range(clean_airbnb$review_scores_rating), step = 1
                    )),
                    div(style="height: 75px;", sliderInput("profit", "Profit per Month ($)", value = range(clean_airbnb$profit_monthly), 
                                min(clean_airbnb$profit_monthly), max(clean_airbnb$profit_monthly)
                                
                    )),
                    div(style="height: 75px;",sliderInput("distance", "Distance from Downtown (KM)", min = 0, max = 26,
                               value = range(clean_airbnb$dist_from_downtown), step = 1
                    )),
                    selectInput("colors", "Color Scheme", selected = "Oranges",
                                rownames(subset(brewer.pal.info, category %in% c("seq", "div")))
                    ),
                    selectInput("roomtype", "Room Type", selected = "All",
                                choices = c("All", as.vector(unique(clean_airbnb$room_type)))
                    ),
                    selectInput("propertytype", "Property Type", selected = "All",
                                choices = c("All", as.vector(unique(clean_airbnb$property_type)))
                    ),
                    selectInput("neighbourhood", "Neighbourhood", selected = "All",
                                  choices = c("All", as.vector(unique(clean_airbnb$neighbourhood_cleansed)))
                    ),
                    

                    checkboxInput("superhost", "Show Only Super Hosts", FALSE),
                    checkboxInput("legend", "Show legend", FALSE)
      )
  )
  
  server <- function(input, output) {
    # Reactive expression for the data subsetted to what the user selected
    filteredData <- reactive({
      room_sel <- if ((input$roomtype=="All")) unique(as.vector(clean_airbnb$room_type)) else input$roomtype
      property_sel <- if ((input$propertytype=="All")) unique(as.vector(clean_airbnb$property_type)) else input$propertytype
      neigh_sel <- if ((input$neighbourhood=="All")) unique(as.vector(clean_airbnb$neighbourhood_cleansed)) else input$neighbourhood
      clean_airbnb %>% 
        filter(total_price >= input$price[1], total_price <= input$price[2]
               ,host_is_superhost == input$superhost) %>% 
        filter(dist_from_downtown >= input$distance[1], 
               dist_from_downtown <= input$distance[2]) %>%
        filter(room_type %in% room_sel, property_type %in% property_sel, neighbourhood_cleansed %in% neigh_sel) %>% 
        filter(review_scores_rating >= input$rating[1], review_scores_rating <= input$rating[2]) %>% 
      filter(profit_monthly >= input$profit[1], profit_monthly <= input$profit[2])
      
      })
    
    # This reactive expression represents the palette function,
    # which changes as the user makes selections in UI.
    colorpal <- reactive({
      colorNumeric(input$colors, clean_airbnb$total_price)
    })
    output$mymap <- renderLeaflet({
      leaflet(data = clean_airbnb) %>% addProviderTiles("CartoDB.DarkMatter") %>%
        fitBounds(~min(longitude), ~min(latitude), ~max(longitude), ~max(latitude))
    })
    # Incremental changes to the map (in this case, replacing the
    # circles when a new color is chosen) should be performed in
    # an observer. Each independent set of things that can change
    # should be managed in its own observer.
    observe({
      pal <- colorpal()
      
      leafletProxy("mymap", data = filteredData()) %>%
        clearShapes() %>%
        addCircles(~longitude, ~latitude, radius = ~review_scores_rating/3, weight = 1, color = "#777777",
                   fillColor = ~pal(total_price), fillOpacity = 0.8, label = ~paste("Neighbourhood: ",neighbourhood_cleansed,"\n$ ", total_price, "\nRating: ",review_scores_rating),
                   popup = ~paste("Rating: ",review_scores_rating)
        )
    })
    # Use a separate observer to recreate the legend as needed.
    observe({
      proxy <- leafletProxy("mymap", data = clean_airbnb)
      
      # Remove any existing legend, and only if the legend is
      # enabled, create a new one.
      proxy %>% clearControls()
      if (input$legend) {
        pal <- colorpal()
        proxy %>% addLegend(position = "bottomright",
                            pal = pal, values = ~total_price
        )
      }
    })
    
  }

  shinyApp(ui, server, options = list(height = 800, width = 800))
```

###

##Summary 

**Summarizing the problem statement:** Analysed the general trends in the price based on property type and neighbourhood. The analysis includes results price, profit and occupancy rates by neighbourhood and various property types, which should help real estate investors and travellers make better decisions. 

**Summarizing the implementation:** The data has been scraped, cleaned and manipulated according to the requirements of the analysis. Derived columns such as occupancy rates, profit per month and distance from downtown was created. Graphs were plotted using GGPlot. A R-Shiny dashboard was also created to enable the user of this project to dive deeper and filter properties according to their requirements.

__Summary/Insights:__ The analysis revealed properties and neighbourhoods which had great return on investment for an investor and value for money a traveler.

* The neighbourhoods of Woodlawn and Rogers Park have a low average price and are closer to the downtown area

* The neighbourhoods of Lincoln Square, Hyde Park and Woodlawn have average monthly profit exceeding $3000

* The properties in Woodlawn cost on an average $150 per night while the properties in Lincoln and Hyde Park cost upward of $225

* Woodlawn has a higher occupancy rate (26 days per month) thus the higher profits

* On an average, instant bookable properties have a higher monthly occupancy rate and the average cost is lower by approx $27

* Airbnb guests to Chicago, book entire homes/apartments for their stay, investors/new hosts, who are willing to offer Entire homes to guests would have a higher monthly profit




